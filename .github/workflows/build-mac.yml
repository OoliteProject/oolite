name: build-mac

on:
  workflow_dispatch:
  push:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout Oolite
        uses: actions/checkout@v2
        with:
          submodules: true

      - name: Checkout libpng
        uses: actions/checkout@v2
        with:
          repository: glennrp/libpng
          path: deps/libpng
          submodules: true

      - name: check environment
        run: |
          xcodebuild -list -workspace Oolite.xcodeproj/project.xcworkspace
          xcodebuild -list -project Oolite.xcodeproj
          echo "Variables:"
          env | sort
          echo "Current directory:"
          pwd
          echo "Filesystem:"
          find .

      - name: run build
        run: |
          xcodebuild -configuration "TestRelease" MACOSX_DEPLOYMENT_TARGET=10.9 OTHER_CFLAGS="-Wno-deprecated-declarations"
#          xcodebuild -scheme 'Oolite - Test Release' build

#      - name: run tests
#        run: |
#          xcodebuild test -scheme 'Oolite - Test Release' -destination target/tests

      - name: Create Release
        run: |
          mkdir -p release/TestRelease
          cp -r build/TestRelease/Oolite.app release/TestRelease
          mkdir -p release/TestRelease/Documentation
          cp Doc/AdviceForNewCommanders.doc release/TestRelease/Documentation
          cp Doc/contributors.txt release/TestRelease/Documentation
          cp Doc/GPL.TXT release/TestRelease/Documentation
          cp Doc/LICENSE.TXT release/TestRelease/Documentation
          cp Doc/OoliteReadMe.pdf release/TestRelease/Documentation
          cp Doc/OoliteRS.pdf release/TestRelease/Documentation
          mkdir -p release/TestRelease/Extras
          cp -r tools/BBC\ keys release/TestRelease/Extras
          cd release; zip --recurse-paths TestRelease.zip TestRelease

      - name: Publish Release
        id: create_release
        uses: "marvinpinto/action-automatic-releases@latest"
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "latest"
          prerelease: true
          title: "Oolite MacOS Nightly"
          files: |
            release/TestRelease.zip
